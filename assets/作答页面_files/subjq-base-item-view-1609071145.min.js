define(["talent","templates/common","BaseQuestionItemView","autoresize","ResultManager"],function(Talent,jst,BaseQuestionItemView,autoresize,resultManager){var DartqItemView=BaseQuestionItemView.extend({template:jst["common/component/subjq/subjq-item"],events:function(){var events={};events["click .simulate_audio_switch"]="playMedia";return events},playMedia:function(e){var node=$(e.currentTarget);var media=node.parents(".audio_wrap").prev().get(0);media.play();node.next().addClass("active_play");media.onended=function(){node.next().removeClass("active_play")}},render:function(){var self=this;this.ishashImg=false;BaseQuestionItemView.prototype.render.apply(this,arguments);this._baseOnAfterRender();var sectionIds=resultManager.statusModel.get("sectionId").split("|");if(!isNaN(Number(sectionIds[1]))){var subjAnswer=Talent.Context.getEditValue(self.model.id);var arr=subjAnswer?subjAnswer.split("^"):[];if(arr.length==3){self.$el.find("textarea").val(arr[0]);self.setUpdateImg(arr[1],arr[2])}else{if(this.model.get("isAllowPhoto")=="1"){self.setAddImg()}}}this.calculateStrLen(Talent.$.trim(this.$el.find("textarea").val()))},_baseOnAfterRender:function(){var name=this.model.get("name")||"";if(name.indexOf("_")!=-1){var status=Talent.Context.resultManager.getQuestionStatus(name.split("_")[0]);if(status==-1||status==1){this.$el.find("textarea").attr({disabled:"disabled",collect:true});this.$el.find("textarea").autosize();return}}this._baseBindEvents()},_baseBindEvents:function(){var self=this;this.$el.find("textarea").on("focus.quiz",function(ev){self.$el.find("label").hide()});this.$el.find("textarea").on("blur.quiz",function(ev){if(self.$el.find("textarea").val()==""){self.$el.find("label").show()}});this.$el.find("label").on("click.quiz",function(ev){self.$el.find("textarea").focus()});this.$el.find("textarea").on("keyup.quiz",function(ev){self.setDataAndStatus(ev)}).on("keydown.quiz input.quiz propertychange.quiz",function(ev){self.setDataAndStatus(ev)});this.$el.find("textarea").autosize();this.$el.find(".preview").on("click.name",function(ev){self.uploadPhotoSucc()});this.$el.find(".closeBtn").on("click.name",function(ev){self.$el.find(".subj_photo").hide();self.$el.find(".fade_tips_red").hide();self.getPhotoImg(false)});this.$el.find(".btn_show_cancel").on("click.name",function(){self.$el.find(".subj_big_photo").hide()});this.$el.find(".close_pop").on("click.name",function(){self.$el.find(".subj_big_photo").hide()})},uploadPhotoSucc:function(){$(".close_pop").remove();this.getPhotoImg(true);return false},getPhotoImg:function(isShow){var self=this;var id=self.model.get("id");Talent.app.request("subj:getPhotoImg",{userID:BSGlobal.loginUserInfo.id,sn:BSGlobal.activityInfo.sn,questionID:id,tenantID:BSGlobal.tenantInfo.id}).done(function(resp){resp=eval("("+resp+")");self.$el.find(".photo_noImg").hide();if(resp&&resp.length==2&&resp[0]["result"]!=""){self.$el.find(".fade_tips_red").hide();self.setUpdateImg(resp[0]["result"]+"?v="+Math.random(),resp[1]["result"]+"?v="+Math.random());self.setDataAndStatusByImg(resp[0]["result"]+"?v="+Math.random(),resp[1]["result"]+"?v="+Math.random());isShow&&self.showBigImg()}else{self.setAddImg();isShow&&self.$el.find(".fade_tips_red").show()}})},setAddImg:function(){var self=this;var str='<div class="quiz_photo photo_noImg">';str+='<a href="javascript:void(0)">手机拍照上传答案</a></div>';self.$el.find(".option_con .quiz_photo").remove();self.$el.find(".option_con").append(str);if(window.location.host.indexOf(".cn")>0){var urlPara="http://mqa.ceping.beisencorp.com"}else{var urlPara="http://www.m.ceping.com"}self.$el.find(".photo_noImg a").on("click.name",function(ev){var imgSrc=Talent.Context.getBaseGlobalInfoByName("assistantPath")+"/api/GetBarCode"+"?sn="+BSGlobal.activityInfo.sn+"&questionID="+self.model.get("id")+"&userID="+BSGlobal.loginUserInfo.id+"&tenantID="+BSGlobal.tenantInfo.id+"&url="+urlPara;self.$el.find(".subj_photo img").attr("src",imgSrc);self.$el.find(".subj_photo").show();return false});self.setImgClick(self.$el.find(".photo_noImg a img"))},setUpdateImg:function(bigUrl,smallUrl){var self=this;var str='<input type="hidden" value="'+bigUrl+'" name='+self.model.id+' id="big'+self.model.id+'">';str+='<input type="hidden" value="'+smallUrl+'" name='+self.model.id+' id="small'+self.model.id+'">';str+='<div class="quiz_photo photo_hasImg">';str+='<img src="'+smallUrl+'" class="uploadImg"><a href="javascript:void(0)">更改图片</a>';str+="</div>";self.$el.find(".option_con input[type=hidden]").remove();self.$el.find(".option_con .quiz_photo").remove();self.$el.find(".option_con").append(str);self.$el.find(".photo_hasImg a").on("click.name",function(ev){self.$el.find(".subj_photo").show();return false});self.setImgClick(self.$el.find(".photo_hasImg img.uploadImg"))},setImgClick:function(oImg){var self=this;oImg.on("click.name",function(ev){if(oImg.hasClass("uploadImg")){self.$el.find(".subj_big_photo").show();self.showBigImg()}})},showBigImg:function(oImg){var self=this;self.$el.find(".subj_photo").hide();self.$el.find(".subj_big_photo").show();self.$el.find(".btn_show_cancel").hide();self.$el.find(".subj_big_photo .fade_con").css("margin-left","-64px").css("margin-top","-100px").css("width","0px").css("height","0px");var showImg=self.$el.find(".subj_big_photo img");showImg.attr("src",BSGlobal.staticPath+"/images/loading.gif");var newImg=new Image;newImg.onload=function(){showImg.load(function(){var height=showImg.height()>450?450:showImg.height();var width=showImg.width()>600?600:showImg.width();self.$el.find(".subj_big_photo .fade_con").css("margin-left",-width/2+"px").css("margin-top",-height/2-30+"px").css("width",width+40).css("height",height+80);showImg.unbind("load")});showImg.attr("src",newImg.src);self.$el.find(".btn_show_cancel").show();newImg=newImg.onload=null};newImg.src=self.$el.find("#big"+self.model.id).val()},setDataAndStatusByImg:function(bigUrl,smallUrl){var self=this;var text=self.$el.find("textarea").val();self.calculateStrLen(text);if(bigUrl&&smallUrl){self.$el.attr("data-status",1);self.$el.trigger("change:status");self.model.setValue(text+"^"+bigUrl+"^"+smallUrl)}},setDataAndStatus:function(ev){var self=this;var text=Talent.$.trim(Talent.$(ev.currentTarget).val());var big=self.$el.find("#big"+self.model.id);var small=self.$el.find("#small"+self.model.id);var bigVal=big.length>0?big.val():"";var smallVal=small.length>0?small.val():"";self.calculateStrLen(text);if(bigVal&&smallVal){self.model.setValue(text+"^"+bigVal+"^"+smallVal);self.$el.attr("data-status",1);self.$el.trigger("change:status");return}else{self.model.setValue(text)}if(text!=""){if(parseInt(self.$el.attr("data-status"))==0){self.$el.attr("data-status",1);self.$el.trigger("change:status")}}else{if(parseInt(self.$el.attr("data-status"))==1){self.$el.attr("data-status",0);self.$el.trigger("change:status")}}},calculateStrLen:function(text){var len=Talent._.calculateStrLen(text);if(len>5e3){var html='<span style="color:#b91110">'+len+"</span>字/可输入5000字";this.$el.find(".num").html(html)}else{var html='<span style="color:#38ba72">'+len+"</span>字/可输入5000字";this.$el.find(".num").html(html)}},onShow:function(){var self=this;setTimeout(function(){var auArr=self.$el.find("audio");var embeds=self.$el.find("embed");Talent.Context.simulateAudioTag(auArr,embeds)},17)}});return DartqItemView});
//# sourceMappingURL=http://sourcemap.beisen.co/ux/tools-assessment/hotfix/app/scripts/views/common/component/subjq/subjq-base-item-view-1609071145.min.map