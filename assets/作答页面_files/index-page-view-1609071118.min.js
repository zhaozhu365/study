define(["talent","templates/quiz","views/common/base/base-region-type","views/quiz/formal/quiz-select-section-view","views/common/component/quiz-fade-view","QuizErrorView","$.cookie","views/common/component/user-feedback-board"],function(Talent,jst,RegionType,QuizSelectSectionView,QuizFadeView,QuizErrorView,Cookie,UserFeedbackBoard){var MainView=Talent.Layout.extend({template:jst["quiz/formal/index-page"],className:"quiz_container",switchType:"section",regions:{main:".quiz_container_inside",fade:".fadePop",messBoard:".user_feedback"},initialize:function(){var self=this;this.judgeGetPageBlur();this.judgeGetCutDown();BSGlobal.blurFlag=false;this.statusModel=new Talent.Model({activityStatus:0});this.listenTo(this.statusModel,"change:sectionId",function(){self.renderSelectSectionView()});Talent.Context.resultManager.statusModel=this.statusModel;this.actTimeLoading=parseInt(Talent.Context.getBaseGlobalInfoByName("actTimeLoading"))},onRender:function(){var self=this;self.getSectionData()},onShow:function(){var self=this;Talent.$(document).on("contextmenu selectstart",function(e){var tagName=Talent.$(e.target)[0].tagName.toLowerCase();if(tagName!="input"&&tagName!="textarea"){e.preventDefault();return false}});Talent._.splash("formal")},judgeGetPageBlur:function(){var notRequestAnswer=Talent.Context.getGlobalInfoByKey("notRequestAnswer");var activityInfo=Talent.Context.getBaseGlobalInfoByName("activityInfo")||{};var isJumpPage=activityInfo.IsJumpPage;if(isJumpPage&&!notRequestAnswer){Talent.Context.getWindowBlur().done(function(resp){if(!resp.message.message&&!resp.message.type){if(resp.IsOver){Talent.app.execute("history:navigate","#quiz/login-error?type=pageblur",true)}}})}},judgeGetCutDown:function(){var notRequestAnswer=Talent.Context.getGlobalInfoByKey("notRequestAnswer");if(!notRequestAnswer){var isHaveResult=Talent.Context.getBaseGlobalInfoByName("isHaveResult");var time=!isHaveResult?1:2;this.getCutdown(time).done(function(time){if(time>0){Talent.app.execute("history:navigate","#quiz/login",true)}})}},getCutdown:function(time){var deferred=new Talent.$.Deferred;var self=this;Talent.app.request("time:getCutdown",{times:time}).done(function(resp){var data=JSON.parse(resp);var time=data.countdown;deferred.resolve(time)});return deferred.promise()},getSectionData:function(){var self=this;Talent.app.request("quizsection:getAllSection",{isRecordInterrupt:true,_v:Math.floor(Math.random()*1e4)}).done(function(resp){var message=resp.message||{};if(message.message&&message.type){message["isShowHead"]=false;self.main&&self.main.show(new QuizErrorView({model:new Talent.Model(message)}));return}Talent.Context.setSessionData("sectionLen",resp.data.length);self.sectionData=resp.data;var activeSection=resp.activeSection;if(!activeSection){activeSection=self.getFirstActiveSection()}if(self.getFirstActiveSection()){self.statusModel.set({activityStatus:0,sectionId:activeSection,sectionStatus:0,isCollectionEnd:resp.isCollectionEnd,forceSubmitTime:resp.forceSubmitTime})}else{self.statusModel.set({activityStatus:1,isCollectionEnd:resp.isCollectionEnd,forceSubmitTime:resp.forceSubmitTime});self.renderSelectSectionView()}})},renderSelectSectionView:function(id){var self=this;this.requestSectionHasSend=false;var quizSelectSectionView=new QuizSelectSectionView({model:this.statusModel,collection:new Talent.Collection(this.sectionData)});self.main.show(quizSelectSectionView);quizSelectSectionView.on("quiz:next:step",function(){self.nextStep()});if(Talent.Context.getBaseGlobalInfoByName("isFirstRememberStartTime"))self.showLoading()},showLoading:function(){this.fade.show(new QuizFadeView({model:new Talent.Model({type:"formalLoading",text:"正在下载题目，请稍候..."})}));this.closeLoading()},closeLoading:function(){var self=this;var loadTime=Math.floor(Math.random(0,1)*self.actTimeLoading);setTimeout(function(){self.fade.close()},loadTime*1e3)},nextStep:function(){var self=this;var sectionId=this.statusModel.get("sectionId");var isCollectionEnd=Talent.Context.getBaseGlobalInfoByName("isCollectionEnd");if(isCollectionEnd==1){Talent.app.request("time:getCollectionCutDown",{sectionId:sectionId}).done(function(resp){if(!resp.message){self.judgeIsShowWaterMark(resp.countdown)}})}else{if(Talent.Context.getBaseGlobalInfoByName("isFirstRememberStartTime")){Talent.app.request("time:getCollectionCutDown",{sectionId:sectionId})}self.judgeIsShowWaterMark()}},judgeIsShowWaterMark:function(coltime){var countdown=countdown||-999;var activityInfo=Talent.Context.getBaseGlobalInfoByName("activityInfo");var staticPath=Talent.Context.getBaseGlobalInfoByName("staticPath");var hostname=location.hostname;if(activityInfo.isEnableCamera){if(window._assessmentStreamRef){this.isShowWaterMark(coltime)}else{this.fade.show(new QuizFadeView({model:new Talent.Model({message:Talent.Context.getPopNoMediDes(),btns:[{type:"btn_continue",text:"确定"}]})}))}}else{this.isShowWaterMark(coltime)}},isShowWaterMark:function(coltime){var self=this;if(Talent.Context.getActivityInfo().isWaterMark){var options={name:Talent.Context.getUserInfo().name};Talent.app.request("subj:getCreateWaterMark",options).done(function(resp){if(!resp.message){Talent.Context.setBSGlobalInfo({waterImage:resp})}self.renderSectionView(coltime)})}else{self.renderSectionView(coltime)}},renderSectionView:function(coltime){var countdown=coltime|-999;var self=this;BSGlobal.isPostPage=true;var sectionId=this.statusModel.get("sectionId");Talent.Context.setSessionData("sectionId",sectionId);if(this.requestSectionHasSend){return}this.requestSectionHasSend=true;if(!Talent.Context.getBaseGlobalInfoByName("isFirstRecordPageChange")){Talent.app.request("time:rememberStartTime",{sectionID:sectionId})}Talent.app.request("quizsection:getSectionDataById",{section:sectionId}).done(function(resp){var message=resp.message||{};if(message.message&&message.type){message["isShowHead"]=false;self.main.show(new QuizErrorView({model:new Talent.Model(message)}));return}var isCollectionEnd=Talent.Context.getBaseGlobalInfoByName("isCollectionEnd");if(isCollectionEnd==1&&coltime>-999){resp.model.acCountDown=coltime}BSGlobal.blurFlag=true;self.statusModel.set({activeSubSection:resp.model.activeSubSection});resp.model=Talent._.extend({},resp.model,{id:sectionId,sectionStatus:0});var View=Talent.Context.quizMapping[resp.viewType];self.quizSectionView=new View({model:new Talent.Model(resp)});self.listenTo(self.quizSectionView.model,"change:activeSubSection",function(model){self.statusModel.set({activeSubSection:model.get("activeSubSection")})});self.listenTo(self.quizSectionView,"question:quiz:statusChange",function(model){self.statusModel.set({sectionStatus:model.get("sectionStatus")});self.onAfterActiveSectionSubmit()});self.main.show(self.quizSectionView)})},getFirstActiveSection:function(){var sectionData=Talent._.findWhere(this.sectionData,{status:0});return sectionData&&sectionData.section},onAfterActiveSectionSubmit:function(){var self=this;this.sectionData=_.updateArrayByAttr(this.sectionData,{section:this.statusModel.get("sectionId")},{status:1});var sectionData=_.findWhereByDistance(this.sectionData,{section:this.statusModel.get("sectionId")},1);if(sectionData){Talent.Context.resultManager.saveRequest().done(function(resp){if(resp&&resp.indexOf("message")!=-1){var resp=JSON.parse(resp)||{};var message=resp.message||{};if(Talent._.isNull(message.message)&&Talent._.isNull(message.type)){if(message.type===null){self.statusModel.set({sectionId:sectionData.section,sectionStatus:0})}else{alert(message.message)}}else{alert(message.message)}}Talent.$(".btn_sure").attr("disabled",false);Talent.$(".btn_exit").attr("disabled",false)})}else{this.statusModel.set({activityStatus:1});Talent.Context.resultManager.saveRequest().done(function(resp){Talent.$(".btn_sure").attr("disabled",false);Talent.$(".btn_exit").attr("disabled",false);if(resp&&resp.indexOf("message")!=-1){var resp=JSON.parse(resp)||{};var message=resp.message||{};if(Talent._.isNull(message.message)&&Talent._.isNull(message.type)){Talent.app.execute("history:navigate","#quiz/complete?type=complete",true)}}})}BSGlobal.blurFlag=false},onClose:function(){}});return Talent.BasePageView.extend({mainViewClass:MainView,pageTitle:"作答页面",hideSidebar:true})});
//# sourceMappingURL=http://sourcemap.beisen.co/ux/tools-assessment/hotfix/app/scripts/views/quiz/formal/index-page-view-1609071118.min.map